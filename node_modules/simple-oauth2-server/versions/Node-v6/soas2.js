'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}if(!process.env.v7)require('babel-polyfill');var path=require('path');Promise.any=require('promise-any');var express=require('express');var bodyParser=require('body-parser');var uuid=require('uuid');var moment=require('moment');var lowdbAPI=require(path.join(__dirname,'../../','api/lowdb'));var DATE_FORMAT='YYMMDDHHmmss';var SimpleOAuth2Server=function(){function SimpleOAuth2Server(){_classCallCheck(this,SimpleOAuth2Server);this.__protection=[['default']];this.defaultOptions={expiredToken:15*60,createTokenPath:'/token',revocationPath:'/tokenRevocation',tokensDB:new lowdbAPI,tokenType:'Bearer'}}_createClass(SimpleOAuth2Server,[{key:'init',value:function init(options,oldFormat){if(oldFormat&&!options.expressApp){oldFormat.expressApp=options;options=oldFormat}this.__configuring(options);this.__isFatalErrors();this.tokensDB.connect();this.expressApp.use(this.__appSettings).use(this.__getTokenRoute).use(this.__revocationTokensRoute);return this}},{key:'defend',value:function defend(options){this.__configuring(options,{routes:['**'],methods:['get','post','delete','put','patch']});this.expressApp.use(this.__loadRoutes);return this}},{key:'layerAnd',value:function layerAnd(){var level=this.__protection.length;return this.__makeLayer.apply(this,[level].concat(Array.prototype.slice.call(arguments)))}},{key:'layerOr',value:function layerOr(){var level=this.__protection.length-1;return this.__makeLayer.apply(this,[level].concat(Array.prototype.slice.call(arguments)))}},{key:'tokenExtend',value:function tokenExtend(){return{}}},{key:'__configuring',value:function __configuring(){var config=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var defaultOptions=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.defaultOptions;if(config.route){config.routes=config.route}if(config.method){config.methods=config.method}if(typeof config.methods==='string'){config.methods=config.methods.replace(/\s/g,'').split(',')}Object.assign(this,defaultOptions,config)}},{key:'__isFatalErrors',value:function __isFatalErrors(){if(!this.expressApp){throw new Error('Where is express application?');exit()}if(!this.authentication){throw new Error('Function for authentication is undefined!');exit()}}},{key:'__authentication',value:function(){var _ref=_asyncToGenerator(regeneratorRuntime.mark(function _callee(request,response){var defaultToken,refresh_token,authResult,token;return regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:defaultToken={access_token:uuid(),refresh_token:uuid(),expires_in:this.expiredToken,expires_at:moment().format(DATE_FORMAT)};refresh_token=request.body.refresh_token;if(!refresh_token){_context.next=8;break}_context.next=5;return this.__checkRefreshToken.call(this,refresh_token);case 5:_context.t0=_context.sent;_context.next=11;break;case 8:_context.next=10;return promiseResult(promiseMiddleware(request,this.authentication));case 10:_context.t0=_context.sent;case 11:authResult=_context.t0;if(!(refresh_token&&authResult||authResult==='success')){_context.next=16;break}token=Object.assign(refresh_token?authResult:this.tokenExtend(request),defaultToken);this.tokensDB.write(token);return _context.abrupt('return',response.send(token));case 16:response401(response,authResult,'\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u0443\u0442\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u0438!');case 17:case'end':return _context.stop();}}},_callee,this)}));function __authentication(_x3,_x4){return _ref.apply(this,arguments)}return __authentication}()},{key:'__deleteTokens',value:function __deleteTokens(request,response){var _request$body=request.body,token_type_hint=_request$body.token_type_hint,token=_request$body.token;this.tokensDB.remove(token_type_hint,token);response.send()}},{key:'__makeLayer',value:function __makeLayer(level){var newObject=this.__copyObject;if(!Array.isArray(newObject.__protection[level])){newObject.__protection[level]=[]}for(var _len=arguments.length,functions=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){functions[_key-1]=arguments[_key]}functions.forEach(function(aFunction){return newObject.__protection[level].push(aFunction)});return newObject}},{key:'__defaultProtect',value:function(){var _ref2=_asyncToGenerator(regeneratorRuntime.mark(function _callee2(request,next,cancel){var access_token,token;return regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!request.token){_context2.next=2;break}return _context2.abrupt('return',next());case 2:access_token=request.get('Authorization')?request.get('Authorization').replace(this.tokenType+' ',''):false;if(!access_token){_context2.next=12;break}_context2.next=6;return this.tokensDB.find('access_token',access_token);case 6:token=_context2.sent;if(!token){_context2.next=12;break}if(!validateToken(token)){_context2.next=11;break}request.token=token;return _context2.abrupt('return',next());case 11:this.tokensDB.remove('access_token',access_token);case 12:cancel('\u041F\u043E\u043F\u044B\u0442\u043A\u0430 \u043D\u0435\u0441\u0430\u043D\u043A\u0446\u0438\u043E\u043D\u0438\u0440\u043E\u0432\u0430\u043D\u043D\u043E\u0433\u043E \u0434\u043E\u0441\u0442\u0443\u043F\u0430!');case 13:case'end':return _context2.stop();}}},_callee2,this)}));function __defaultProtect(_x5,_x6,_x7){return _ref2.apply(this,arguments)}return __defaultProtect}()},{key:'__checkRefreshToken',value:function(){var _ref3=_asyncToGenerator(regeneratorRuntime.mark(function _callee3(refresh_token){var token;return regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return this.tokensDB.find('refresh_token',refresh_token);case 2:token=_context3.sent;if(!token){_context3.next=6;break}this.tokensDB.remove('refresh_token',refresh_token);return _context3.abrupt('return',moment(token.expires_at,DATE_FORMAT).add(1,'week')>moment()?token:false);case 6:case'end':return _context3.stop();}}},_callee3,this)}));function __checkRefreshToken(_x8){return _ref3.apply(this,arguments)}return __checkRefreshToken}()},{key:'__layers',get:function get(){var _this=this;var __thisLayers=copyArray(this.__protection);return function(){var _ref4=_asyncToGenerator(regeneratorRuntime.mark(function _callee4(request,response,next){var checkToken,thisLayers,checkAll;return regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return promiseResult(promiseMiddleware(request,_this.__defaultProtect.bind(_this)));case 2:checkToken=_context4.sent;__thisLayers[0][0]=checkToken==='success'?Promise.resolve():Promise.reject(checkToken);thisLayers=__thisLayers.map(function(layer,i){return Promise.any(layer.map(function(aFunction,j){return i+j?promiseMiddleware(request,aFunction):aFunction}))});_context4.next=7;return promiseResult(Promise.all(thisLayers));case 7:checkAll=_context4.sent;checkAll==='success'?next():response401(response,checkAll[0]);case 9:case'end':return _context4.stop();}}},_callee4,_this)}));return function(_x9,_x10,_x11){return _ref4.apply(this,arguments)}}()}},{key:'__revocationTokensRoute',get:function get(){return express.Router().post(this.revocationPath,this.__deleteTokens.bind(this))}},{key:'__getTokenRoute',get:function get(){return express.Router().post(this.createTokenPath,this.__authentication.bind(this))}},{key:'__appSettings',get:function get(){return express.Router().use(bodyParser.urlencoded({extended:false})).use(function(request,response,next){response.setHeader('Access-Control-Allow-Origin','*');response.setHeader('Access-Control-Allow-Methods','GET, POST, PUT, DELETE, PATCH');response.setHeader('Access-Control-Allow-Headers','X-Requested-With, content-type, Authorization');next()})}},{key:'__loadRoutes',get:function get(){var _this2=this;var router=express.Router();this.methods.forEach(function(method){return router[method](_this2.routes,_this2.__layers)});return router}},{key:'__copyObject',get:function get(){var newObject=Object.create(this);newObject.__protection=copyArray(this.__protection);return newObject}}]);return SimpleOAuth2Server}();module.exports=new SimpleOAuth2Server;function promiseMiddleware(request,aFunction){return new Promise(function(resolve,reject){aFunction(request,resolve,reject)})}function promiseResult(promise){return promise.then(function(){return'success'}).catch(function(message){return message!=='success'?message:false})}function copyArray(array){return array.map(function(subArray){return subArray.slice()})}function validateToken(token){var expires_at=token.expires_at,expires_in=token.expires_in;var expired=moment(expires_at,DATE_FORMAT).add(expires_in,'seconds');return expired>moment()}function response401(response,errMsg){var altMsg=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'\u041E\u0448\u0438\u0431\u043A\u0430 \u0430\u0432\u0442\u043E\u0440\u0438\u0437\u0430\u0446\u0438\u0438!';response.status(401).send({'message':typeof errMsg==='string'?errMsg:altMsg})}
